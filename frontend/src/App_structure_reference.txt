import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  ShoppingCart, 
  Wallet, 
  Activity, 
  Users, 
  BrainCircuit, 
  AlertTriangle, 
  TrendingUp,
  X,
  Plus,
  Minus,
  CheckCircle2,
  Clock,
  Flame,
  Info,
  Leaf,
  Beef,
  Sprout,
  Search,
  ChevronDown,
  ArrowUpRight,
  ArrowDownLeft,
  CreditCard,
  Share2,
  History,
  Sparkles,
  Utensils,
  Timer,
  UserPlus,
  Trash2,
  MapPin,
  Bike,
  Phone,
  MessageSquare,
  CheckCircle,
  Home,
  Navigation,
  Map as MapIcon,
  List,
  Filter,
  Zap,
  Loader2,
  Globe,
  Smartphone,
  Banknote,
  RotateCcw,
  Gift,
  ShieldCheck,
  Building,
  Lock,
  Heart,
  Facebook,
  Twitter,
  Instagram
} from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

import { MOCK_RESTAURANTS, MOCK_DISHES, MOCK_COUPONS } from './constants';
import { 
  Dish, 
  Restaurant, 
  CartItem, 
  UserProfile, 
  HealthCondition, 
  Tag, 
  GroupMember, 
  Transaction,
  UserLocation,
  Coordinates,
  PaymentMethod,
  Coupon
} from './types';
import { getFoodRecommendation, FoodRecommendation, generateRestaurantMenu, generateDishFromQuery } from './services/geminiService';

// Declare Leaflet globally for TypeScript
declare const L: any;

// --- Helper Functions ---

const calculateDistance = (lat1: number, lon1: number, lat2: number, lon2: number): number => {
  const R = 6371; // Radius of the earth in km
  const dLat = (lat2 - lat1) * (Math.PI / 180);
  const dLon = (lon2 - lon1) * (Math.PI / 180);
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * 
    Math.sin(dLon / 2) * Math.sin(dLon / 2); 
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
  const d = R * c; // Distance in km
  return parseFloat(d.toFixed(1));
};

// --- Components ---

const Navbar = ({ 
  cartCount, 
  balance, 
  onViewChange, 
  currentView,
